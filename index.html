<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="assets/css/reset.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <title>Document</title>
</head>

<body>
    <header>
        <h1 id="title">Star Wars RPG</h1>
    </header>
    <h3>Your Character</h3>
    <div id="all-characters" class="row">

    </div>
    <hr>
    <h3>Enemies Available to Attack</h3>
    <div id="enemies-available" class="row">

    </div>
    <hr>
    <div id="fight-section">
        <h3>Fight Section</h3><button id="fight-button">Fight!</button>
    </div>
    <hr>
    <h3>Defender</h3>
    <div id="defender" class="row"></div>
    <div id="fight-result"></div>
    <hr>
    <div><button id="reset-game">Reset Game</button></div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- <script src="assets/javascript/game.js"></script> -->
    <script>

        const charactersInitialState = {
            "Obi-Wan-Kenobi": {
                name: "Obi-Wan-Kenobi",
                hp: 120,
                "attack-power": 8,
                "counter-attack-power": 8
            },
            "Luke-Skywalker": {
                name: "Luke-Skywalker",
                hp: 100,
                "attack-power": 5,
                "counter-attack-power": 5
            },
            "Darth-Sidious": {
                name: "Darth-Sidious",
                hp: 150,
                "attack-power": 20,
                "counter-attack-power": 20
            },
            "Darth-Maul": {
                name: "Darth-Maul",
                hp: 180,
                "attack-power": 25,
                "counter-attack-power": 25
            }
        };

        let charactersDeepCopy = {};

        const game = {
            state: {
                finished: false,
                win: false,
                loss: false
            },
            selectedCharacter: "",
            selectedDefender: "",
            defeatedCharacters: 0,
            totalCharacters: 0,

            fight(selectedCharacter, defender) { // (str, str)
                const chosenCharacterAttack = charactersDeepCopy[selectedCharacter]["attack-power"];
                charactersDeepCopy[selectedCharacter].hp -= charactersDeepCopy[defender]["counter-attack-power"];
                charactersDeepCopy[defender].hp -= chosenCharacterAttack;
                charactersDeepCopy[selectedCharacter]["attack-power"] += chosenCharacterAttack;
            },
            setGameState(finished, win, loss) {
                this.state.finished = false;
                this.state.win = false;
                this.state.loss = false;
            },
            resetGameState() {
                this.selectedCharacter = "";
                this.selectedDefender = "";
                this.setGameState(false, false, false);
                this.totalCharacters = 0;
                this.defeatedCharacters = 0;
            }
        }

        $(document).ready(function () {

            function bindCharacterClick(box) {
                // Moves character boxes to appropriate row based on game state
                box.click(function () {
                    if (!game.selectedCharacter) {
                        box.addClass("chosen-character");
                        $("#all-characters").children(".character-box").each(function () {
                            if (!$(this).is(box)) {
                                $(this).addClass("enemy")
                                $("#enemies-available").append($(this));
                            }
                        });
                        game.selectedCharacter = box.attr("name");
                    } else if (!game.selectedDefender && game.selectedCharacter) {
                        box.addClass("defender");
                        $("#defender").append(box);
                        game.selectedDefender = box.attr("name");
                    }

                })
            }

            function resetGame() {

                // Reset game state
                game.resetGameState();

                // Remove character boxes from all rows
                [$("#all-characters"), $("#enemies-available"), $("#defender"), $("#fight-result")].forEach(jQObj => {
                    jQObj.empty();
                });

                // Initialize all-character section with character boxes
                charactersDeepCopy = JSON.parse(JSON.stringify(charactersInitialState));;
                Object.values(charactersDeepCopy).forEach(stats => {
                    game.totalCharacters++;
                    const characterBox = $("<div>");
                    const name = $("<div>");
                    name.text(stats.name);

                    const hp = $("<div>");
                    const attack = $("<div>")
                    hp.text("Health: " + stats["hp"]);
                    hp.attr("class", "hp");
                    attack.text("Attack: " + stats["attack-power"]);
                    attack.attr("class", "attack")

                    characterBox
                        .addClass("character-box")
                        .attr("name", stats.name)
                        .attr("id", stats.name)
                        .append(name)
                        .append(hp)
                        .append(attack)

                    bindCharacterClick(characterBox);

                    $("#all-characters").append(characterBox);
                });
            }

            resetGame();

            $("#reset-game").click(() => {
                resetGame();
            });

            $("#fight-button").click(() => {

                if (game.state.finished || !game.selectedCharacter || !game.selectedDefender) {
                    return
                }
                const selectedCharacterStr = game.selectedCharacter
                const defenderStr = game.selectedDefender
                const selectedCharacter = charactersDeepCopy[selectedCharacterStr]
                const defender = charactersDeepCopy[defenderStr]
                const yourAttack = selectedCharacter["attack-power"];
                const defenderAttack = defender["counter-attack-power"]

                game.fight(selectedCharacterStr, defenderStr);
                if (selectedCharacter.hp <= 0) {
                    game.state.finished = true;
                    game.state.loss = true;
                    $("#reset-game").show();
                }
                if (defender.hp <= 0) {
                    $("#defender").empty();
                    game.selectedDefender = "";
                    game.defeatedCharacters++;
                    $("#fight-result").text("You have defeated " + defenderStr + "! Choose another enemy to continue.")

                } else {
                    $("#" + defenderStr)
                        .children(".hp")
                        .text("Health: " + defender.hp);
                    $("#fight-result").text("You attacked " + defenderStr + " for " + yourAttack + " damage. "
                        + defenderStr + " attacked you for back for " + defenderAttack + " damage.")
                }

                const selectedCharacterObj = $("#" + selectedCharacterStr);
                selectedCharacterObj
                    .children(".hp")
                    .text("Health: " + selectedCharacter.hp)

                selectedCharacterObj
                    .children(".attack")
                    .text("Attack: " + selectedCharacter["attack-power"]);

                if (game.state.loss) {
                    $("#fight-result").text(defenderStr + " defeated you. GAME OVER! Press restart to try again.")
                }
                if (game.defeatedCharacters === game.totalCharacters - 1) {
                    game.state.finished = true;
                    game.state.win = true
                    $("#fight-result").text("You won! GAME OVER! Press restart to play again.")
                }
            });
        });

    </script>

</body>

</html>